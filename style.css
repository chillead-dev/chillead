/* ======================================================
   UTILS
====================================================== */
function qs(id){ return document.getElementById(id); }

function formatTime(ms){
  const s = Math.floor(ms / 1000);
  const m = Math.floor(s / 60);
  return `${m}:${String(s % 60).padStart(2,'0')}`;
}

function timeAgo(ts){
  const diff = Date.now() - ts;
  const m = Math.floor(diff / 60000);
  if (m < 1) return 'just now';
  if (m < 60) return `${m} min ago`;
  const h = Math.floor(m / 60);
  return `${h} h ago`;
}

/* ======================================================
   ALIVE TIMER + LOCAL TIME
====================================================== */
(function(){
  const born = new Date('2010-08-05T00:00:00+05:00').getTime();
  const aliveEl = qs('alive');
  const timeEl = qs('localTime');

  function tick(){
    const now = Date.now();
    const diff = now - born;

    const d = Math.floor(diff / 86400000);
    const h = Math.floor(diff / 3600000) % 24;
    const m = Math.floor(diff / 60000) % 60;
    const s = Math.floor(diff / 1000) % 60;

    if (aliveEl) aliveEl.textContent = `${d}d ${h}h ${m}m ${s}s`;
    if (timeEl) timeEl.textContent =
      new Date().toLocaleTimeString('en-GB',{ hour:'2-digit', minute:'2-digit', second:'2-digit' });
  }

  tick();
  setInterval(tick, 1000);
})();

/* ======================================================
   SPOTIFY — NOW PLAYING
====================================================== */
async function loadNowPlaying(){
  try{
    const r = await fetch('/api/now-playing');
    const data = await r.json();

    const card = qs('nowPlaying');
    const empty = qs('npEmpty');

    if (!data || !data.ok || !data.playing){
      card.classList.add('hidden');
      empty.style.display = 'block';
      return;
    }

    const item = data.item;
    if (!item) return;

    qs('npCover').src = item.cover;
    qs('npTitle').textContent = item.name;
    qs('npTitle').href = item.url;
    qs('npArtist').textContent = item.artist;

    qs('npTime').textContent = formatTime(data.progress);
    qs('npDuration').textContent = formatTime(item.duration);

    const pct = Math.min(100, Math.max(0, (data.progress / item.duration) * 100));
    qs('npFill').style.width = pct + '%';

    card.classList.remove('hidden');
    empty.style.display = 'none';

  }catch(e){
    console.error('now playing error', e);
  }
}

/* ======================================================
   HISTORY (LOCAL)
====================================================== */
function renderHistory(){
  const el = qs('history');
  if (!el) return;

  const raw = localStorage.getItem('spotify_history');
  if (!raw) return;

  let list;
  try{ list = JSON.parse(raw); }
  catch{ return; }

  el.innerHTML = '';

  list.slice(0,20).forEach(t=>{
    const card = document.createElement('div');
    card.className = 'track-card';

    card.innerHTML = `
      <img src="${t.cover}">
      <div class="track-meta">
        <div class="track-title">${t.name}</div>
        <div class="track-artist">${t.artist}</div>
        <div class="track-ago">${timeAgo(t.time)}</div>
      </div>
    `;
    el.appendChild(card);
  });
}

/* ======================================================
   LETTERBOX (SAFE SEND)
====================================================== */
(function(){
  const btn = qs('sendLetter');
  const ta = qs('letterText');

  if (!btn || !ta) return;

  btn.onclick = async ()=>{
    const text = ta.value.trim();
    if (text.length < 3) return;

    btn.disabled = true;
    btn.textContent = '[ sending… ]';

    try{
      const r = await fetch('/api/letters/submit',{
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ message:text })
      });
      const data = await r.json();

      if (data.ok){
        ta.value = '';
        btn.textContent = '[ sent ]';
      }else{
        btn.textContent = '[ error ]';
      }
    }catch(e){
      btn.textContent = '[ error ]';
    }

    setTimeout(()=>{
      btn.disabled = false;
      btn.textContent = '[ send ]';
    },1200);
  };
})();

/* ======================================================
   INIT
====================================================== */
loadNowPlaying();
renderHistory();
setInterval(loadNowPlaying, 15000);
